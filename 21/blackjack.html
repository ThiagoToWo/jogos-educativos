<!DOCTYPE html>
<html>
<head>
	<title>Blackjack	</title>
	<meta charset='utf-8'/>
	<style>
	canvas {background: green;}
	#ptsj {
		position: absolute;
		left: 1010px;
		top: 100px;
	}
	#ptsc {
		position: absolute;
		left: 1010px;
		top: 300px;
	}
	</style>
	<script>
	const DECK = new Image();
	DECK.src = 'baralho.png';
	const CARTA_W = 960 / 13;
	const CARTA_H = 575 / 5;
	
	// classe Carta
	function Carta(naipe, simbolo, valor, linha, coluna) {
		this.naipe = naipe;
		this.simbolo = simbolo;
		this.valor = valor;		
		this.linha = linha;
		this.coluna = coluna;
	}
	
	Carta.prototype.desenharFrente = function(x, y) {
		ctx.drawImage(DECK, 					// imagem
					  this.linha * CARTA_W,		// coordenada x do clip
					  this.coluna * CARTA_H,	// coordenada y do clip
					  CARTA_W,					// largura do clip
					  CARTA_H,					// comprimento do clip
					  x, 						// coordenada x do desenho
					  y,						// coordenada y do desenho
					  CARTA_W, 					// largura do desenho
					  CARTA_H);					// comprimento do desenho
	}
	
	Carta.prototype.desenharCostas = function(x, y) {
		ctx.drawImage(DECK, 					// imagem
					  2 * CARTA_W,				// coordenada x do clip
					  4 * CARTA_H,				// coordenada y do clip
					  CARTA_W,					// largura do clip
					  CARTA_H,					// comprimento do clip
					  x, 						// coordenada x do desenho
					  y,						// coordenada y do desenho
					  CARTA_W, 					// largura do desenho
					  CARTA_H);					// comprimento do desenho
	}
	
	// classe Baralho
	function Baralho(valores) {
		this.cartas = [];
		this.topo = -1;
		this.valores = valores;
		
		var simbolos = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
		var naipes = ['paus', 'ouros', 'copas', 'espadas'];
				
		for (var j = 0; j < naipes.length; j++) {
			for (var i = 0; i < simbolos.length; i++) {
				this.cartas.push(new Carta(naipes[j], simbolos[i], valores[i], i, j));
			}
		}
	}
	
	Baralho.prototype.embaralhar = function() {
		var j;
		var temp;
		
		for (var i = this.cartas.length - 1; i > 0; i--) {
			j = Math.floor(Math.random() * (i + 1));
			temp = this.cartas[j];
			this.cartas[j] = this.cartas[i];
			this.cartas[i] = temp;
		}
	}
	
	Baralho.prototype.distribuir = function() {
		if (this.topo < this.cartas.length) {
			return this.cartas[++this.topo];
		} else {
			alert('Acabou as cartas do baralho.\
				  Reinicie a página para começar com outro.')
		}		
	}
	
	var canvas; // elemento canvas
	var ctx; // contexto 2d do canvas
	var botDeal; // botão de comprar mais carta
	var botHold; // botão de manter a mão
	var botNew; // botão de nova rodada
	var pontosJogador; // guarda o span para exibir pontos do jogador
	var pontosCasa; // guarda o span para exibir pontos da casa
	var baralho; // guarda o objeto baralho
	var maoJogador = []; // guarda as cartas dos jogadores
	var maoCasa = []; // guarda as cartas da casa
	var jogadorX = 100; // posisão x inicial das cartas do jogador
	var jogadorY = 400; // posisão y inicial das cartas do jogador
	var casaX = 500 - CARTA_W / 2; // posisão x inicial das cartas da casa
	var casaY = 100; // posisão y inicial das cartas da casa
	var dX = 30; // guarda o deslocamanto horizontal de desenho das cartas
	var pontos = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 10, 10]; // o ponto de cada carta
	var totalCasa = 0; // total de pontos da casa
	var totalJogador = 0; // total de pontos do jogador
	var msgX = 30; // a posisão x da mensagem
	var msgY = 50; // a posisão y da mensagem
	
	function init() {
		canvas = document.getElementById('canvas');
		ctx = canvas.getContext('2d');
		botDeal = document.getElementById('deal');
		botHold = document.getElementById('hold');
		botNew = document.getElementById('new');
		pontosJogador = document.getElementById('ptsj');
		pontosCasa = document.getElementById('ptsc');
		
		botDeal.addEventListener('click', distribuirCartas, false);
		botHold.addEventListener('click', manterMao, false);
		botNew.addEventListener('click', novaRodada, false);
		ctx.font = 'italic 20pt Georgia';
		
		baralho = new Baralho(pontos);
		baralho.embaralhar();
		darMaoInicial();
	}

	function darPara(mao, viradaParaCima) {
		mao.push(baralho.distribuir());	
		
		if (mao == maoJogador) {
			baralho.cartas[baralho.topo].desenharFrente(jogadorX, jogadorY);
			jogadorX += dX;
			totalJogador = somarPontos(mao);
			pontosJogador.textContent = 'Pontos do jogador = ' + totalJogador;
		} else {
			if (viradaParaCima || viradaParaCima === undefined) {
				baralho.cartas[baralho.topo].desenharFrente(casaX, casaY);
			} else {
				baralho.cartas[baralho.topo].desenharCostas(casaX, casaY);
			}
			casaX += dX;
			totalCasa = somarPontos(mao);			
		}		
	}
	
	function darMaoInicial() {
		darPara(maoJogador);
		darPara(maoCasa, false);
		darPara(maoJogador);
		darPara(maoCasa);
	}
	
	function distribuirCartas() {
		darPara(maoJogador);
		
		/*if (totalCasa < 17) {
			darPara(maoCasa);
		}*/
	}
	
	function manterMao() {
		botDeal.disabled = true;
		while (totalCasa < 17) {
			darPara(maoCasa);
		}
		
		mostrarCasa();
		
		if (totalJogador > 21) { // jogador perdeu?
			if (totalCasa > 21) { // casa perdeu?
				ctx.fillText('Você e a casa perderam.', msgX, msgY);
			} else { // casa ganhou?
				ctx.fillText('Você estourou os 21 pontos e perdeu.', msgX, msgY);
			}			
		} else { // jogador pode ganhar?
			if (totalCasa > 21) { // casa perdeu?
				ctx.fillText('A casa estourou os 21 pontos e perdeu.', msgX, msgY);
			} else { // os dois menores que 21?
				if (totalJogador > totalCasa) { 
					ctx.fillText('Você ganhou!', msgX, msgY);
				} else if (totalJogador == totalCasa) {
					ctx.fillText('Houve um empate.', msgX, msgY);
				} else {
					ctx.fillText('Você perdeu!', msgX, msgY);
				}
			}
		}
	}
	
	function mostrarCasa() {
		casaX = 500 - CARTA_W / 2;
		
		for (var i = 0; i < maoCasa.length; i++) {
			maoCasa[i].desenharFrente(casaX, casaY);
			casaX += dX;
			pontosCasa.textContent = 'Pontos da casa = ' + totalCasa;
		}
	}
	
	function somarPontos(mao) {
		var soma = 0;
		var ases = 0;
		
		for (var i = 0; i < mao.length; i++) {
			soma += mao[i].valor;
			if (mao[i].valor == 1) {
				ases++
			}
		}
		
		if ((ases > 0) && (soma + 10 <= 21)) {
			soma += 10;
		}
		
		return soma;
	}
	
	function novaRodada() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		jogadorX = 100;
		casaX = 500 - CARTA_W / 2;
		maoCasa = [];
		maoJogador = [];
		totalCasa = 0;
		totalJogador = 0;
		botDeal.disabled = false;
		pontosCasa.textContent = 'Pontos da casa = ?';
		darMaoInicial();
	}	
	
	window.onload = init;	
	</script>
</head>
<body>
	<canvas id='canvas' width='1000' height='600'></canvas>
	<br/>
	<button id='deal'>Comprar</button>
	<button id='hold'>Manter</button>
	<button id='new'>Nova rodada</button>
	<span id='ptsj'></span>
	<span id='ptsc'>Pontos da casa = ?</span>
</body>
</html>