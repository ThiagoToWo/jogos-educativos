<!doctype html>
<html>
<head>
	<title>Lançamento de projéteis</title>
	<meta name='viewport' content='width=device-width initial-scale=1'/>
	<meta charset='utf-8'/>
	<script>
		var canvas;
		var ctx;
		const PPM = 5 // Relação pixel por metros.
		var x_0 = 10;
		var y_0 = 440;		
		var acao;
		var mouse_x;
		var mouse_y;
		var mouse_move = false;
		var grav = 2;
		var v0;
		var vx_0;
		var vy_0;
		var y_max;
		var x_max;
		var t_ar;
		var ang_grau;
		var bala;
		var alvo;
		var chao;
		var seta;
		var tudo = [];
		
		function Bala(x, y, r, cor) {
			this.x = x;
			this.y = y;
			this.r = r;
			this.vx = 0;
			this.vy_inicial = 0;
			this.vy_final = 0;
			this.cor = cor;
			this.seta = seta;
			this.trajetoria = [[this.x, this.y]];
			this.trajetoria_ativada = true;
			
			this.atualizar = function() {
				var dx = this.vx;
				this.vy_final = this.vy_inicial + grav;
				var dy = (this.vy_inicial + this.vy_final)/ 2;
				this.vy_inicial = this.vy_final;
				
				this.x += dx;
				this.y += dy;
				
				this.trajetoria.push([this.x, this.y]);
			}
			this.desenhar = function() {
				ctx.fillStyle = this.cor;
				ctx.beginPath();
				ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
				ctx.fill();
			}
			this.desenharTrajetoria = function() {
				if (!this.trajetoria_ativada) return;
				
				ctx.fillStyle = this.cor;
				ctx.save();
								
				for (var i in this.trajetoria) {					
					ctx.beginPath();
					ctx.arc(this.trajetoria[i][0], this.trajetoria[i][1], 2, 0, 2 * Math.PI);
					ctx.fill();
				}
				
				ctx.restore();
			}
		}
		
		function Alvo(x, y, w, h, cor) {
			this.x = x;
			this.y = y;
			this.w = w;
			this.h = h;
			this.meio = x + w / 2;
			this.cor = cor;
			this.ativado = true;
			this.atingido = false;
			
			this.atualizar = function() {
			
			}
			this.desenhar = function() {
				if (!this.ativado) return;
				
				new Retangulo(this.x, this.y, this.w, this.h, this.cor).desenhar();
			}
			this.mostrarObjetivo = function() {
				ctx.save();
				ctx.fillStyle = 'black';
				ctx.font = 'bold 20px sans-serif';
				ctx.fillText(
					'Me acerte: ' + this.meio / PPM + 'm', 
					this.x,
					this.y + this.h + 20
				);
				ctx.restore();
			}
			
		}
		function Retangulo(x, y, w, h, cor) {
			this.x = x;
			this.y = y;
			this.w = w;
			this.h = h;
			this.cor = cor;
			
			this.atualizar = function(dx, dy) {
				
			}
			this.desenhar = function() {
				ctx.fillStyle = this.cor;
				ctx.fillRect(this.x, this.y, this.w, this.h);
			}
		}

		function Seta(origem, cor) {
			this.o = origem;
			this.x = 0;
			this.y = 0;
			this.w = 0;
			this.h = 0;
			this.ang_rad = 0;
			this.ang_grau = 0;
			this.ponta_x = 0;
			this.ponta_y = 0;	
			this.cor = cor;
			this.ativada = false;
			
			this.atualizar = function() {
				this.x = this.o.x;
				this.y = this.o.y - this.o.r / 2;
				this.w = 2 * Math.sqrt(this.o.vx**2 + this.o.vy_inicial**2);
				this.h = this.o.r;
				this.ang_rad = Math.atan(this.o.vy_inicial / this.o.vx);
				this.ponta_x = this.x + this.w + 2 * this.h;
				this.ponta_y = this.y + this.h / 2;
			}
			this.desenhar = function() {
				if (!this.ativada) return;				
				
				ctx.save();
				ctx.translate(this.x, this.y  + this.h / 2);
				ctx.rotate(this.ang_rad);
				ctx.translate(-this.x, -this.y  - this.h / 2);
				ctx.fillStyle = this.cor;
				ctx.fillRect(this.x, this.y, this.w, this.h);
				
				ctx.beginPath();
				ctx.moveTo(
					this.x + this.w,
					this.y - this.h / 2					
				)
				ctx.lineTo( // ponta da seta
					this.ponta_x,
					this.ponta_y					
				)
				ctx.lineTo(
					this.x + this.w,
					this.y + 3 * this.h / 2					
				)
				ctx.closePath();
				ctx.fill();
				ctx.restore();
			}			
		}
		
		function main() {
			canvas = document.getElementById('canvas');
			ctx = canvas.getContext('2d');
			canvas.addEventListener('mousedown', acharBola);
			canvas.addEventListener('mousemove', moverSeta);
			canvas.addEventListener('mouseup', atirarComSeta);
			
			bala = new Bala(x_0, y_0, 10, 'black');
			seta = new Seta(bala, 'red');
			chao = new Retangulo(0, 450, canvas.width, 50, 'green');
			
			var h_alvo = 10;
			var w_alvo = 100;
			var y_alvo = chao.y - h_alvo;
			var x_alvo = 200 + Math.floor(Math.random() * (canvas.width - w_alvo - 200));
			
			alvo = new Alvo(x_alvo, y_alvo, w_alvo, h_alvo, 'purple');	
						
			var nuvem1 = new Retangulo(100, 80, 200, 30, 'white');
			var nuvem2 = new Retangulo(20, 100, 500, 30, 'white');
			var nuvem3 = new Retangulo(800, 10, 100, 20, 'white');
			var nuvem4 = new Retangulo(750, 120, 600, 40, 'white');
			
			tudo.push(chao);
			tudo.push(nuvem1);
			tudo.push(nuvem2);
			tudo.push(nuvem3);
			tudo.push(nuvem4);			
			tudo.push(bala);
			tudo.push(seta);
			tudo.push(alvo);
			
			desenharTudo();
		}
		
		function desenharTudo() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			
			for (var i in tudo) {
				tudo[i].desenhar();
			}			
			
			alvo.mostrarObjetivo();
			bala.desenharTrajetoria();
		}		
		
		function acharBola(e) {			
			configurarMouse(e);
			
			var distsqr = (mouse_x - bala.x)**2 + (mouse_y - bala.y)**2;
			
			if (distsqr < (bala.r)**2) {
				mouse_move = true;
				seta.ativada = true;
				seta.atualizar();
				desenharTudo();
			}
		}
		
		function moverSeta(e) {			
			if (mouse_move) {
				configurarMouse(e);
				
				vx_0 = Math.abs(mouse_x - bala.x);
				vy_0 = Math.abs(mouse_y - bala.y);
				v0 = Math.sqrt(vx_0 * vx_0 + vy_0 * vy_0);
				ang_grau = Math.atan(vy_0 / vx_0) * 180 / Math.PI;			
				
				bala.vx = vx_0;
				bala.vy_inicial = -vy_0;				
				
				seta.ang_grau = ang_grau;
				seta.atualizar();
				
				desenharTudo();				
				
				mostrarValores();
				
				y_max = vy_0**2 / 19.6;
				t_ar = 2 * vy_0 / 9.8;
				x_max = vx_0 * t_ar;
			}			
		}
		
		function configurarMouse(e) {
			if (e.layerX || e.layerX == 0) {
				mouse_x = e.layerX;
				mouse_y = e.layerY;
			} else if (e.offsetX || e.offsetX == 0) {
				mouse_x = e.offsetX;
				mouse_y = e.offsetY;
			}
		}
		
		function atirarComSeta() {
			if (mouse_move) {
				mouse_move = false;
				
				acao = setInterval(processar, 100);
			}			
		}
		
		function atirar() {
			visual()
			
			acao = setInterval(processar, 100);
			
			return false;
		}
		
		function visual() {
			bala.x = x_0;
			bala.y = y_0;			
			
			if (f1.vx.value > 36 || f1.vx.value < 0) {
				alert("A velocidade horizontal deve ser de 0 a 36");
				return;
			}
			
			if (f1.vy.value > 41 || f1.vy.value < 0) {
				alert("A velocidade vertical deve ser de 0 a 41");
				return;
			}			
			
			vx_0 = Number(f1.vx.value);
			vy_0 = Number(f1.vy.value);	
			v0 = Math.sqrt(vx_0 * vx_0 + vy_0 * vy_0);
			ang_grau = Math.atan(vy_0 / vx_0) * 180 / Math.PI;
			
			configurarValores();	
			
			desenharTudo();
		}
		
		function atirarComAng() {
			visualComAng();
			
			acao = setInterval(processar, 100);
			
			return false;
		}
		
		function visualComAng() {
			bala.x = x_0;
			bala.y = y_0;
			
			if (f2.v0.value > 54 || f2.v0.value < 0) {
				alert("A velocidade deve ser de 0 a 55");
				return;
			}
			
			if (f2.ang.value > 90 || f2.ang.value < 0) {
				alert("O ângulo deve ser de 0° a 90°");
				return;
			}			
			
			ang_grau = Number(f2.ang.value);
			var ang = ang_grau * Math.PI / 180;
			vx_0 = Number(f2.v0.value) * Math.cos(ang);
			vy_0 = Number(f2.v0.value) * Math.sin(ang);
			v0 = Math.sqrt(vx_0 * vx_0 + vy_0 * vy_0);
			
			configurarValores();			
			
			desenharTudo();
		}		
		
		function configurarValores() {
			bala.vx = vx_0;
			bala.vy_inicial = -vy_0;
			
			seta.ativada = true;
			seta.ang_grau = ang_grau;
			seta.atualizar();
			
			y_max = vy_0**2 / 19.6;
			t_ar = 2 * vy_0 / 9.8;
			x_max = vx_0 * t_ar;
		}
		
		function processar() {
			bala.atualizar();
			seta.atualizar();
			
			if (bala.y + bala.r >= chao.y) {				
				clearInterval(acao);
				desenharTudo();
				mostrarValores();
				mostrarResultados();
			} else if (colidiuComAlvo()) {
				alvo.atingido = true;				
				clearInterval(acao);
				desenharTudo();
				mostrarValores();
				mostrarResultados();
			} else {
				desenharTudo();
			}
		}
		
		function colidiuComAlvo() {
			var bx = bala.x - bala.r;
			var by = bala.y - bala.r;
			var bw = bh = 2 * bala.r;
			
			return bx + bw > alvo.x &&
				bx  < alvo.x + alvo.w &&
				by + bh > alvo.y &&
				by > alvo.y + alvo.h;
		}
		function mostrarValores() {
			ctx.font = 'bold 20px sans-serif';
			ctx.fillText('Velocidade inicial: ' + v0.toFixed(2) + 'm/s', 10, 26);
			ctx.fillText('Ângulo: ' + ang_grau.toFixed(2) + '°', 10, 46);
			ctx.fillText('Velocidade horizontal: ' + vx_0.toFixed(2) + 'm/s', 10, 66);
			ctx.fillText('Velocidade vertical: ' + vy_0.toFixed(2) + 'm/s', 10,86);
		}
		
		function mostrarResultados() {
			ctx.font = 'bold 20px sans-serif';
			ctx.fillText('Altura máxima: ' + y_max.toFixed(0) + 'm', 10, 160);
			ctx.fillText('Alcance horizontal: ' + x_max.toFixed(0) + 'm', 10, 180);
			ctx.fillText('Tempo no ar: ' + t_ar.toFixed(0) + 's', 10, 200);
		}
	</script>
	<style>
		canvas {background: skyblue;}
		form {
			width:330px;
			margin:20px;
			background: brown;
			padding: 20px;
			display: inline-table;
		}
		input:valid {background: green;}
		input:invalid {background: red;}		
	</style>
</head>
<body onLoad='main();'>
	<canvas id='canvas' width='1500' height='500'></canvas>
	<br/>
	<form>
		<p>Clique e segure o botão esquerdo do mouse sobre a bola e arraste para configurar o ângulo e a velocidade de lançamento. Solte o botão para atirar.<p/>
		<p>Reinicie a página para tentar novamente ou configure e visualize atráves de umas das entradas de formulário.<p/>
	</form>
	<form name='f1' onSubmit='return atirar();'>
		Velocidade horizontal: <input name='vx' type='number' value='20' min='0' max='36'/>m/s
		<br/>
		Velocidade vertical: <input name='vy' type='number' value='25' min='0' max='41'/>m/s
		<br/>
		<input type='button' value='Visualizar' onClick='visual();'/>
		<br/>
		<input type='submit' value='Atirar'/>
	</form>
	<form name='f2' onSubmit='return atirarComAng();'>
		Velocidade inicial: <input name='v0' type='number' value='20' min='0' max='54'/>m/s
		<br/>
		Ângulo: <input name='ang' type='number' value='45' min='0' max='90'/>°
		<br/>
		<input type='button' value='Visualizar' onClick='visualComAng();'/>
		<br/>
		<input type='submit' value='Atirar'/>
	</form>
</body>
</html>