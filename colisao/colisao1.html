<!doctype html>
<html>
<head>
	<title>Colisões Unidimensionais</title>
	<meta name='viewport' content='width=device-width initial-scale=1'/>
	<meta charset='utf-8'/>
	<script>
		var canvas;
		var ctx;
		const PPM = 5 // Relação pixel por metros.
		var x_a = 100;
		var x_b = 750;
		var acao;
		var chao;
		var coproA;
		var corpoB;
		var colisor;
		var tudo = [];
		
		function Corpo(x, cor) {			
			this.m = 5;
			this.r = 10;
			this.x = x;			
			this.y = 440;			
			this.v = 0;
			this.cor = cor;
		}
		
		Corpo.prototype.atualizar = function() {
			this.x += this.v;
		}
		
		Corpo.prototype.desenhar = function() {
			ctx.beginPath();
			ctx.fillStyle = this.cor;
			ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
			ctx.fill();
			ctx.closePath();
		}
		
		Corpo.prototype.colidiuCom = function(outro) {
			var x = this.x - this.r;
			var w = 2 * this.r;
			var ox = outro.x - outro.r;
			var ow = 2 * outro.r;
			return (x + w >= ox) &&
			       (x <= ox + ow);		
		}
		
		function Retangulo(x, y, w, h, cor) {
			this.x = x;
			this.y = y;
			this.w = w;
			this.h = h;
			this.cor = cor;			
		}
		
		Retangulo.prototype.desenhar = function() {
			ctx.fillStyle = this.cor;
			ctx.fillRect(this.x, this.y, this.w, this.h);
		}
		
		function Colisor() {
			this.elementos = [];
		}
		
		Colisor.prototype.adicionar = function(elemento) {
			this.elementos.push(elemento);
		}
		
		Colisor.prototype.processar = function() {			
			loop:
			for (var i in this.elementos) {
				for(var j in this.elementos) {
					var a = this.elementos[i];
					var b = this.elementos[j];
					if (i != j && a.colidiuCom(b)) {
						var v1_final = (a.m-b.m)*a.v/(a.m+b.m) + (2*b.m)*b.v/(a.m+b.m);
						var v2_final = (2*a.m)*a.v/(a.m+b.m) + (b.m-a.m)*b.v/(a.m+b.m);
						a.v = v1_final;
						b.v = v2_final;
						break loop;
					}
				}
			}
		}
		
		function main() {
			canvas = document.getElementById('canvas');
			ctx = canvas.getContext('2d');
			
			corpoA = new Corpo(x_a, 'red');
			corpoB = new Corpo(x_b, 'blue');
			
			colisor = new Colisor();
			colisor.adicionar(corpoA);
			colisor.adicionar(corpoB);
			
			chao = new Retangulo(0, 450, canvas.width, 50, 'green');			
			var nuvem1 = new Retangulo(100, 80, 200, 30, 'white');
			var nuvem2 = new Retangulo(20, 100, 500, 30, 'white');
			var nuvem3 = new Retangulo(800, 10, 100, 20, 'white');
			var nuvem4 = new Retangulo(750, 120, 600, 40, 'white');
			
			tudo.push(chao);
			tudo.push(nuvem1);
			tudo.push(nuvem2);
			tudo.push(nuvem3);
			tudo.push(nuvem4);			
			tudo.push(corpoA);
			tudo.push(corpoB);
			
			desenharTudo();
		}
		
		function desenharTudo() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			
			for (var i in tudo) {
				tudo[i].desenhar();
			}			
		}		
		
		function iniciar() {
			visual()
			
			acao = setInterval(processar, 100);
			
			return false;
		}
		
		function visual() {
			corpoA.x = x_a;
			corpoA.m = Number(f.m1.value);
			corpoA.v = Number(f.v1.value);
			corpoA.r = 2 * corpoA.m;
			corpoA.y = 450 - corpoA.r;
			
			corpoB.x = x_b;
			corpoB.m = Number(f.m2.value);
			corpoB.v = Number(f.v2.value);
			corpoB.r = 2 * corpoB.m;
			corpoB.y = 450 - corpoB.r;
			
			desenharTudo();
		}
			
		function processar() {			
			corpoA.atualizar();
			corpoB.atualizar();
			
			desenharTudo();
			
			colisor.processar();
		}		
	</script>
	<style>
		canvas {background: skyblue;}
		form {
			width:410px;
			margin:20px;
			background: brown;
			padding: 20px;
			display: inline-table;
		}
		input:valid {background: green;}
		input:invalid {background: red;}
		article {
			text-align: left;
			margin: 10px;
			border: 5px green double;
			padding: 10px;
			display: inline-table;
		}		
		#formulas{width: ;}
		#exemplo1{width: ;}
		#exemplo2{width: 450px;}
	</style>
</head>
<body onLoad='main();'>
	<h1>Simulador de Colisões</h1>
	<article>
		<ul>
		<li>Simule a colisão unidimensional entre dois corpos.</li>
		</ul>
	</article>
	<canvas id='canvas' width='1500' height='500'></canvas>
	<br/>
	<form name='f' onSubmit='return iniciar();'>
		Massa A: <input name='m1' type='number' value='5' min='5' max='20'/>kg
		<br/>
		Velocidade inicial A: <input name='v1' type='number' value='25' min='1' max='40'/>m/s
		<br/>
		Massa B: <input name='m2' type='number' value='5' min='5' max='20'/>kg
		<br/>
		Velocidade inicial B: <input name='v2' type='number' value='25' min='-40' max='40'/>m/s
		<br/>
		<input type='button' value='Visualizar' onClick='visual();'/>
		<br/>
		<input type='submit' value='Iniciar'/>
	</form>	
</body>
</html>